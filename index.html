<script>
let charac, charac2, charac3;
let r,g,b,prev_r, prev_g, prev_b, prev_bright, mode;
		
function StartBLE() {
	let filters = [];
    let options = {};
	navigator.bluetooth.requestDevice({ filters: [{ services: ['000000ff-0000-1000-8000-00805f9b34fb']  }] })
	.then(device => device.gatt.connect())
	.then(server => {
		return server.getPrimaryService('000000ff-0000-1000-8000-00805f9b34fb');
	})
	.then(service => {
		service.getCharacteristic('0000ff01-0000-1000-8000-00805f9b34fb')
	.then(characteristic => {
		charac = characteristic;
		characteristic.readValue()
	.then(value => {
		prev_r = value.getUint8(0);
		prev_g = value.getUint8(1);
		prev_b = value.getUint8(2);
		let col = "#" + value.getUint8(0).toString(16) + value.getUint8(1).toString(16) + value.getUint8(2).toString(16);
		document.getElementById("html5colorpicker").setAttribute("value", col);
	});
	});
	service.getCharacteristic('0000ff02-0000-1000-8000-00805f9b34fb')
	.then(characteristic => {
		charac2 = characteristic;
		characteristic.readValue()
	.then(value => {
	prev_bright = value.getUint8();
		
		document.getElementById("myRange").value = value.getUint8();
		});
	});
		mode = value.getUint8();
		service.getCharacteristic('0000ff03-0000-1000-8000-00805f9b34fb')
	.then(characteristic => {charac3 = characteristic});
		return service.getCharacteristic('0000ff01-0000-1000-8000-00805f9b34fb');
	})
	.then(characteristic => {
	})
	.then(value => {
	})
	.catch(error => { console.error(error); });
	}
  function Writete() {
  
  let sensorbits = 0;
  	if (document.getElementById("Mode").value == "MS") {
	sensorbits |= (1 << 2);
	}
	else if (document.getElementById("Mode").value == "US") {
	sensorbits |= (1 << 1);
	}
	else if (document.getElementById("Mode").value == "AL") {
	sensorbits |= (1 << 0);
		}
	
	c = document.getElementById("html5colorpicker").value;
	r = parseInt(c.substring(1,3),16);
	g = parseInt(c.substring(3,5),16);
	b = parseInt(c.substring(5),16);
	lum = document.getElementById("myRange").value;
	a_rgb = Int8Array.of(r, g, b);
	a_lum = Int8Array.of(lum);
	a_sensorbits = Int8Array.of(sensorbits);
	if (prev_r != r && prev_g != g && prev_b != g) {
		charac.writeValue(a_rgb);
		prev_r = r;
		prev_g = g;
		prev_b = b;
	}
	if (prev_bright != lum) {
		charac2.writeValue(a_lum);
		prev_bright = lum;
	}
	if (mode != sensorbits) {
		charac3.writeValue(a_sensorbits);
		mode = sensorbits;
		}
  }

	function clickColor() {
	colours = document.getElementById("html5colorpicker").value;
	}
	function Read() {
			charac2.readValue().then(value => {
			document.getElementById("abc").innerHTML = "";
			document.getElementById("abc").innerHTML += "Brightness:" + value.getUint8(0);
		})
			charac3.readValue().then(value => {
		})

		return charac.readValue().then(value => {

			document.getElementById("abc").innerHTML += "Red:" + value.getUint8(0);
			document.getElementById("abc").innerHTML += "Green:" + value.getUint8(1);
			document.getElementById("abc").innerHTML += "Blue:" + value.getUint8(2);
z
		})
	}
		function Turnoff() {
		let bright = Int8Array.of(0);
		document.getElementById("myRange").value = bright;
		charac2.writeValue(bright);
	}
  </script>

  
<html>
    <div class="x"> <button type="button" onclick="StartBLE()">Start BLE</button></div>

    <br>
    <div id="IoButtons" class="x">
        <div id="ColorIntensity">
			Colour: <br>
            <input type="color" id="html5colorpicker" onchange="clickColor(0, -1, -1, 5)" value="#ff0000" style="width:80%;">
            <br> <br>
            <div class="slidecontainer">	Brightness: <br>
                <input type="range" min="0" max="255" value="0" class="slider" id="myRange"style="width:80%;"">
            </div>
        </div>
        <br>
<form>
  <label for="Mode">Choose mode:</label>
  <select name="Mode" id="Mode">
    <option id="MS" value="MS">Motion sensor</option>
    <option id="US" value="US">Ultrasonic sensor</option>
    <option id="AL" value="AL">Ambient light</option>
    <option id="MAN" value="MANUAL">Manual</option>
  </select>
  <br><br>
</form>
			<div class="x">
		
	<button type="button" onclick="Writete()">Write</button>
    <button type="button" onclick="Read()">Read</button>
	<button type="button" onclick="Turnoff()">Turn off</button>
	
	</div>
    </div>
	
	<div id="abc" class="x"></div>
    </html>
	
	<style>
	.z {
	text-align: left;
	}
	.y {
	text-align: center;
	margin-left: 45%;
	margin-right: 45%;
	}
.x {
  grid-area: myArea;
  padding: 25px;
  text-align: center;
}

</style>
